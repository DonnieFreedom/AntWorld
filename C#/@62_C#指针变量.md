# C#指针变量

[Microsoft C# 编码约定](https://learn.microsoft.com/zh-cn/dotnet/csharp/fundamentals/coding-style/coding-conventions)

[Microsoft C# 参考](https://learn.microsoft.com/zh-cn/previous-versions/visualstudio/visual-studio-2012/618ayhy6(v=vs.110))

[Microsoft C#文档](https://learn.microsoft.com/zh-cn/dotnet/csharp/)

默认情况下 C# 是不支持指针的, 是为了保持类型的安全性

使用 unsafe 关键字来修饰类或类中的成员，这样的类或类中成员就会被视为不安全代码，C# 允许在不安全代码中使用指针变量。

在公共语言运行时 (CLR) 中，不安全代码是指无法验证的代码，不安全代码不一定是危险的，只是 CLR 无法验证该代码的安全性。因此 CLR 仅会执行信任程序集中包含的不安全代码。



- ### 指针变量

- ### 使用指针检索数据的值

- ### 将指针作为参数传递给函数

- ### 使用指针访问数组元素

- ### 编译不安全代码

> 

#### 指针变量

在 C# 中，指针同样是一个变量，但是它的值是另一个变量的内存地址，在使用指针之前我们同样需要先声明指针，声明指针的语法格式如下所示：

```C#
type* var_name;
```

定义指针的示例如下:

| 示例      | 说明                         |
| --------- | ---------------------------- |
| int* p    | p 是指向整数的指针           |
| double* p | p 是指向双精度数的指针       |
| float* p  | p 是指向浮点数的指针         |
| int** p   | p 是指向整数的指针的指针     |
| int*[] p  | p 是指向整数的指针的一维数组 |
| char* p   | p 是指向字符的指针           |
| void* p   | p 是指向未知类型的指针       |

与声明变量相同，我们同样可以在一行代码中同时声明多个指针，如下所示：

```C#
int* p1, p2, p3;  // 定义 p1、p2、p3 三个整数指针
```

指针类型不能从对象中继承，并且装箱和拆箱也不支持指针，但是不同的指针类型以及指针与整型之间可以进行转换。

 C# 中 unsafe 关键字和指针的使用样例:

```C#
using System;
namespace c.biancheng.net
{
    class Demo
    {
        static unsafe void Main(string[] args)
        {
            double f = 3.1415;
            double* p = &f;
            Console.WriteLine("数据的内容是: {0} ",  f);
            Console.WriteLine("数据在内存中的地址是: {0}",  (int)p);
            Console.ReadKey();
        }
    }
}
/*
字符串的内容是: 3.1415
字符串在内存中的地址是: 11530344
*/
```

在编译上述代码时需要在编译命令中添加`-unsafe`，例如`csc -unsafe demo.cs`。

#### 使用指针检索数据的值

在 C# 中，可以使用 ToString() 来获取指针变量所指向的数据的值, 如下所示:

```C#
using System;
namespace c.biancheng.net
{
    class Demo
    {
        public static void Main()
        {
            unsafe
            {
                int var = 123456;
                int* p = &var;
                Console.WriteLine("变量 var 的值为: {0} " , var);
                Console.WriteLine("指针 p 指向的值为: {0} " , p->ToString());
                Console.WriteLine("指针 p 的值为: {0} " , (int)p);
            }
            Console.ReadKey();
        }
    }
}
/*
变量 var 的值为: 123456
指针 p 指向的值为: 123456
指针 p 的值为: 13889084
*/
```



#### 将指针作为参数传递给函数

将指针变量作为参数传递给函数, 如下所示: 

```C#
using System;
namespace c.sharp
{
    class Demo
    {
        public unsafe void swap(int* p, int *q)
        {
            int temp = *p;
            *p = *q;
            *q = temp;
        }
        public unsafe static void Main()
        {
            Demo p = new Demo();
            int var1 = 10;
            int var2 = 20;
            int* x = &var1;
            int* y = &var2;
            Console.WriteLine("调用 Swap 函数前: var1:{0}, var2: {1}", var1, var2);
            p.swap(x, y);
            Console.WriteLine("调用 Swap 函数后: var1:{0}, var2: {1}", var1, var2);
            Console.ReadKey();
        }
    }
}

/*
调用 Swap 函数前: var1:10, var2: 20
调用 Swap 函数后: var1:20, var2: 10
*/
```



#### 使用指针访问数组元素

在 C# 中，数组和指向该数组且与数组名称相同的指针是不同的数据类型，例如`int* p`和`int[] p`

您可以增加指针变量 p 的值，因为它在内存中不是固定的，但数组地址在内存中是固定的，因此您不能增加数组 p 的值。

如果您需要使用指针变量访问数组数据，可以像在 C 或 C++ 中所做的那样，使用 fixed 关键字来固定指针。[fixed 语句参考](https://learn.microsoft.com/zh-cn/previous-versions/f58wzh21(v=vs.110)?redirectedfrom=MSDN)

```C#
using System;
namespace c.biancheng.net
{
    class Demo
    {
        public unsafe static void Main()
        {
            int[]  list = {10, 100, 200};
            fixed(int *ptr = list)
            /* 显示指针中数组地址 */
            for ( int i = 0; i < 3; i++)
            {
                Console.WriteLine("list[{0}] 的内存地址为：{1}",i,(int)(ptr + i));
                Console.WriteLine("list[{0}] 的值为：{1}", i, *(ptr + i));
            }
            Console.ReadKey();
        }
    }
}

/*
list[0] 的内存地址为：51981272
list[0] 的值为：10
list[1] 的内存地址为：51981276
list[1] 的值为：100
list[2] 的内存地址为：51981280
list[2] 的值为：200
*/
```



#### 编译不安全代码

为了编译不安全代码，在编译时必须使用`unsafe`命令, 如下所示:

```
csc /unsafe demo.cs
或
csc -unsafe demo.cs
```

 Visual Studio在项目属性中启用不安全代码步骤如下：

- 通过双击资源管理器（Solution Explorer）中的属性（properties）节点，打开项目属性（project properties）；
- 点击 Build 标签页；
- 选择选项“Allow unsafe code”。
